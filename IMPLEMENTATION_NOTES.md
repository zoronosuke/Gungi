# 軍儀 駒の動きとスタック機能 実装完了

## 実装内容

https://github.com/nigaor/gungi を参考に、軍儀の本家ルールに準拠した駒の動きとスタック（ツケ）機能を実装しました。

### 主な変更点

#### 1. 駒の動きパターンの詳細定義 (`src/engine/piece.py`)

各駒について、スタックレベル（1段目、2段目、3段目）に応じた動きを定義しました。

- **1段目（base）**: 基本的な動き
- **2段目（evolved）**: 強化された動き
- **3段目（mastered/極）**: 最強の動き（一部の駒はジャンプ可能）

例: 兵（HYO）の場合
- 1段目: 前後1マス
- 2段目: 前後1-2マス
- 3段目: 前後1-3マス（ジャンプ可能）

#### 2. スタック（ツケ）のルール実装

以下のルールを正しく実装しました：

1. **最大3段までスタック可能**
2. **帥の上には乗せられない**
3. **自分より高いスタックには移動・取得・ツケ不可**
4. **砦は他の駒の上に乗れない**（piece.pyに既存）

#### 3. 駒の動きの方向性

プレイヤーに応じて駒の動きを正しく反転：
- 黒プレイヤー（先手）: 上方向が前
- 白プレイヤー（後手）: 下方向が前

#### 4. ジャンプ機能

3段目（極）の一部の駒は、途中に駒があってもジャンプして移動可能：
- 兵（3段目）
- 馬（3段目）
- 忍（3段目）
- 砦（3段目）
- 弓（3段目）
- 筒（3段目）
- 砲（3段目）
- 謀（3段目）

#### 5. 持ち駒を打つ（新）のルール

- **最前線より前には打てない**
- 空マスまたは味方の駒の上に打てる
- 帥の上には打てない
- スタック高さ3のマスには打てない

### 実装された駒の動きパターン

| 駒 | 1段目 | 2段目 | 3段目（極） |
|----|-------|-------|------------|
| 帥 | 8方向1マス | 8方向1-2マス | 8方向1-3マス |
| 大 | 斜め4方向1マス | 斜め4方向1-2マス | 斜め4方向1-3マス |
| 中 | 直線4方向1マス | 直線4方向1-2マス | 直線4方向1-3マス |
| 小 | 金将型 | 金将型+拡張 | 金将型+大幅拡張 |
| 侍 | 前方3方向+後方1マス | +前方3方向2マス+後方2マス | +前方3方向3マス+後方3マス |
| 兵 | 前後1マス | 前後1-2マス | 前後1-3マス（ジャンプ） |
| 馬 | 直線4方向2マス | 直線4方向2-3マス | 直線4方向2-4マス（ジャンプ） |
| 忍 | 斜め8方向1-2マス | 斜め8方向1-3マス | 斜め8方向1-4マス（ジャンプ） |
| 槍 | 前方強化型 | 前方強化型+拡張 | 前方強化型+大幅拡張 |
| 砦 | 防御型 | 防御型+拡張 | 防御型+大幅拡張（ジャンプ） |
| 弓 | 前方特殊型 | 前方特殊型+拡張 | 前方特殊型+大幅拡張（ジャンプ） |
| 筒 | 前後斜め型 | 前後斜め型+拡張 | 前後斜め型+大幅拡張（ジャンプ） |
| 砲 | 前方3マス+側方型 | 前方4マス+側方型+拡張 | 前方5マス+側方型+大幅拡張（ジャンプ） |
| 謀 | 斜め前+後方型 | 斜め前+後方型+拡張 | 斜め前+後方型+大幅拡張（ジャンプ） |

### テスト結果

すべてのテストが成功しました：

1. ✅ 基本的な盤面操作
2. ✅ 初期配置の読み込み
3. ✅ 合法手の生成
4. ✅ 駒の移動
5. ✅ スタック機能（ツケ）
6. ✅ スタックレベルによる動きの変化
7. ✅ スタック高さ制限
8. ✅ 帥の保護ルール

### ファイル構成

- `src/engine/piece.py`: 駒の定義と動きパターン
- `src/engine/rules.py`: ゲームルールと合法手の生成
- `src/engine/move.py`: 手の定義
- `src/engine/board.py`: 盤面管理
- `src/engine/initial_setup.py`: 初期配置
- `tests/test_engine.py`: 基本機能テスト
- `tests/test_stack.py`: スタック機能テスト

### 使用方法

```python
from src.engine import Board, Player, PieceType, Piece, Rules
from src.engine.initial_setup import load_initial_board

# 初期盤面を読み込む
board = load_initial_board()

# 合法手を取得
legal_moves = Rules.get_legal_moves(board, Player.BLACK)

# 手を適用
Rules.apply_move(board, legal_moves[0])

# スタックレベルに応じた動きを取得
piece = board.get_top_piece((4, 4))
stack_level = board.get_stack_height((4, 4))
pattern = piece.get_move_pattern(stack_level)
```

### 参考リポジトリとの互換性

参照した https://github.com/nigaor/gungi の実装と同様に：

- ツケは3段まで可能
- スタックレベルに応じて駒の動きが変化
- 自分より高いスタックには移動不可
- 帥の上には乗せられない
- 「新」は最前線より前には打てない

すべてのルールが正しく実装されています。
