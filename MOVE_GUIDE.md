# 軍儀 駒の動きガイド

## スタック（ツケ）による動きの変化

駒を重ねる（ツケる）ことで、駒の動きが強化されます。

### スタックレベル

- **1段目（基本）**: 通常の動き
- **2段目（強化）**: 動ける範囲が広がる
- **3段目（極）**: 最大範囲＋一部の駒はジャンプ可能

### 各駒の動きの変化

#### 兵（HYO）
- **1段目**: 前後1マス
  ```
      ○
      兵
      ○
  ```
- **2段目**: 前後1-2マス
  ```
      ○
      ○
      兵
      ○
      ○
  ```
- **3段目（極）**: 前後1-3マス（ジャンプ可能）
  ```
      ○
      ○
      ○
      兵
      ○
      ○
      ○
  ```

#### 帥（SUI）
- **1段目**: 8方向に1マス（王将と同じ）
  ```
    ○ ○ ○
    ○ 帥 ○
    ○ ○ ○
  ```
- **2段目**: 8方向に1-2マス
  ```
    ○ ○ ○ ○ ○
    ○ ○ ○ ○ ○
    ○ ○ 帥 ○ ○
    ○ ○ ○ ○ ○
    ○ ○ ○ ○ ○
  ```
- **3段目（極）**: 8方向に1-3マス
  ```
    ○ ○ ○ ○ ○ ○ ○
    ○ ○ ○ ○ ○ ○ ○
    ○ ○ ○ ○ ○ ○ ○
    ○ ○ ○ 帥 ○ ○ ○
    ○ ○ ○ ○ ○ ○ ○
    ○ ○ ○ ○ ○ ○ ○
    ○ ○ ○ ○ ○ ○ ○
  ```

#### 馬（UMA）
- **1段目**: 直線方向に2マス＋左右1マス
  ```
        ○
        ○
    ○ 馬 ○
        ○
        ○
  ```
- **2段目**: 直線方向に2-3マス＋左右1-2マス
  ```
        ○
        ○
        ○
    ○ ○ 馬 ○ ○
        ○
        ○
        ○
  ```
- **3段目（極）**: 直線方向に2-4マス＋左右1-3マス（ジャンプ可能）
  ```
        ○
        ○
        ○
        ○
  ○ ○ ○ 馬 ○ ○ ○
        ○
        ○
        ○
        ○
  ```

#### 忍（SHINOBI）
- **1段目**: 斜め方向に1-2マス
  ```
    ○ ・ ・ ・ ○
    ・ ○ ・ ○ ・
    ・ ・ 忍 ・ ・
    ・ ○ ・ ○ ・
    ○ ・ ・ ・ ○
  ```
- **2段目**: 斜め方向に1-3マス
  ```
    ○ ・ ・ ・ ・ ・ ○
    ・ ○ ・ ・ ・ ○ ・
    ・ ・ ○ ・ ○ ・ ・
    ・ ・ ・ 忍 ・ ・ ・
    ・ ・ ○ ・ ○ ・ ・
    ・ ○ ・ ・ ・ ○ ・
    ○ ・ ・ ・ ・ ・ ○
  ```
- **3段目（極）**: 斜め方向に1-4マス（ジャンプ可能）
  ```
    ○ ・ ・ ・ ・ ・ ・ ・ ○
    ・ ○ ・ ・ ・ ・ ・ ○ ・
    ・ ・ ○ ・ ・ ・ ○ ・ ・
    ・ ・ ・ ○ ・ ○ ・ ・ ・
    ・ ・ ・ ・ 忍 ・ ・ ・ ・
    ・ ・ ・ ○ ・ ○ ・ ・ ・
    ・ ・ ○ ・ ・ ・ ○ ・ ・
    ・ ○ ・ ・ ・ ・ ・ ○ ・
    ○ ・ ・ ・ ・ ・ ・ ・ ○
  ```

## 弓（YUMI）の特殊ルール

弓は通常の移動ルールに加えて、**条件付きジャンプ**の特殊能力を持ちます。

### 基本の動き
- **1段目**: 前2マス（左・中央・右）、後ろ1マス
- **2段目**: 前3マス（左2・中央・右2）、後ろ2マス
- **3段目**: 前4マス（左3・中央・右3）、後ろ3マス + ジャンプ可能

### 特殊ルール：条件付きジャンプ

**1つ前のマスに駒（味方・敵問わず）がある場合**：
- 自分のスタック高さ >= 障害物のスタック高さ なら、その駒を飛び越えて前2マス先に移動可能

#### 例1：1段の弓 + 1段の障害物
```
    ○敵  ← 飛び越えて攻撃可能
    味方  ← 1つ前に駒がある
    弓(1段)
```
✅ 1段 >= 1段 なので飛び越えられる

#### 例2：1段の弓 + 2段の障害物  
```
    ×    ← 飛び越えられない
    味方x2 (2段) ← 障害物が高い
    弓(1段)
```
❌ 1段 < 2段 なので飛び越えられない

#### 例3：2段の弓 + 2段の障害物
```
    ○    ← 飛び越えて移動可能
    味方x2 (2段)
    弓(2段)
```
✅ 2段 >= 2段 なので飛び越えられる

### 注意事項
- この特殊ルールは**前2マス（左・中央・右）の移動**にのみ適用されます
- 3段目の弓は通常のジャンプ機能も持つため、より遠くまで移動可能です
- 斜め方向の移動には、この特殊ルールは適用されません

## ジャンプ機能（3段目のみ）

3段目（極）になると、以下の駒は**途中に駒があってもジャンプして移動可能**になります：

- 兵（HYO）
- 馬（UMA）
- 忍（SHINOBI）
- 砦（TORIDE）
- 弓（YUMI）
- 筒（TSUTU）
- 砲（HOU）
- 謀（BOU）

例：3段目の兵
```
    ○  ← ここに移動可能
    ×  ← 途中に敵の駒があってもジャンプできる
    ×  ← 途中に敵の駒があってもジャンプできる
    兵（3段）
```

## スタックのルール

### 重ねる（ツケる）条件
1. 最大3段まで重ねられる
2. 帥の上には乗せられない
3. 自分より高いスタックには移動・取得・ツケ不可

### 例：スタック高さ制限

```
盤面の状態:
  (5,5): 1段の兵（自分）
  (4,5): 2段の敵兵
  (3,5): 3段の敵兵

結果:
  (5,5) → (4,5): ✗ 移動不可（2段 > 1段）
  (5,5) → (3,5): ✗ 移動不可（3段 > 1段）
```

自分の駒のスタック高さ以下のマスにのみ移動できます。

## 持ち駒を打つ（新）

### ルール
1. **最前線より前には打てない**
   - 先手（黒）：自分の駒がある最も上の行より上には打てない
   - 後手（白）：自分の駒がある最も下の行より下には打てない

2. 空マスまたは味方の駒の上に打てる

3. 帥の上には打てない

4. スタック高さ3のマスには打てない

### 例：最前線制限

```
先手（黒）の場合:

  0  w w w    ← 敵陣
  1  w w w
  2  w w w
  3  ✗ ✗ ✗   ← ここには打てない（最前線より前）
  4  ✗ ✗ ✗   ← ここには打てない（最前線より前）
  5  b ・ ・   ← 最前線（row=5）
  6  b b b    ← ここには打てる
  7  ○ ○ ○   ← ここには打てる
  8  ○ ○ ○   ← ここには打てる

b = 黒の駒（最前線）
w = 白の駒
○ = 打てる
✗ = 打てない
```

## 盤面表示の見方

### スタック表示

```
b兵/b兵/b兵  ← 3段積み（一番下から順に表示）
```

### 選択時の表示

```
★  = 選択中の駒
○  = 移動可能なマス（空）
○駒 = 移動可能なマス（駒あり）
```

## テストコマンド

駒の動きを確認するには：

```bash
python tests/test_moves_visual.py
```

スタック機能を確認するには：

```bash
python tests/test_stack.py
```
